---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { RoutineManagement } from "../../components/RoutineManagement";
import { Button } from "@/components/ui/button";
import { RoutineService } from "@/services/routine-service";

export const prerender = false;

const { groupId } = Astro.params;

if (!groupId) {
	return Astro.redirect("/routines");
}

const group = await RoutineService.getGroupById(groupId);

if (!group) {
	return Astro.redirect("/404");
}

const routines = group.routines.map((r) => ({
	...r,
	exerciseCount: r.exercises.length,
}));
---

<BaseLayout title={`Manage ${group.name}`}>
	<div class="container mx-auto py-8 px-4">
		<div class="flex justify-between items-center mb-6">
			<div class="space-y-1">
				<a
					href="/routines"
					class="text-sm text-muted-foreground hover:underline"
					>‚Üê Back to groups</a
				>
			</div>
			{
				!group.isActive && (
					<Button id="set-active-btn" data-group-id={group.id} variant="accent">
						Set as active cycle
					</Button>
				)
			}
		</div>

		<RoutineManagement
			client:load
			groupId={group.id}
			groupName={group.name}
			groupDescription={group.description}
			isActive={group.isActive}
			routines={routines}
		/>
	</div>

	<script>
		import { actions } from "astro:actions";
		import { navigate } from "astro:transitions/client";

		document.addEventListener("astro:page-load", () => {
			const btn = document.getElementById("set-active-btn");
			if (btn) {
				btn.addEventListener("click", async () => {
					const groupId = btn.dataset.groupId;
					if (!groupId) return;
					const { error } = await actions.routine.setActiveGroup({ groupId });
					if (!error) {
						navigate(location.pathname);
					}
				});
			}
		});
	</script>
</BaseLayout>
