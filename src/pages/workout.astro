---
import Layout from "@/layouts/BaseLayout.astro";
import { WorkoutService } from "@/services/workout-service";
import { fade } from "astro:transitions";
import { ActiveWorkout } from "../components/ActiveWorkout";

export const prerender = false;

const { searchParams } = Astro.url;
const logId = searchParams.get("id");

if (!logId) {
	return Astro.redirect("/");
}

const { workoutData, error, redirect } =
	await WorkoutService.getWorkoutPageData(logId);

if (redirect) {
	return Astro.redirect(redirect);
}
---

<Layout title="Active Workout">
	<div class="bg-background" transition:animate={fade({ duration: "0.3s" })}>
		{
			workoutData ? (
				<ActiveWorkout
					client:only="react"
					logId={workoutData.logId}
					initialStartTime={workoutData.initialStartTime}
					routineName={workoutData.routineName}
					routineId={workoutData.routineId}
					routineGroupId={workoutData.routineGroupId}
					routineExerciseIds={workoutData.routineExerciseIds}
					exercises={workoutData.exercises}
					initialSupersetStatus={workoutData.initialSupersetStatus}
					routineExercisesList={workoutData.routineExercisesList}
					isDeload={workoutData.isDeload}
				/>
			) : (
				<div class="flex flex-col items-center justify-center h-full p-8 gap-4">
					<p class="text-destructive text-lg font-semibold">
						{error || "Workout not found"}
					</p>
					<a href="/" class="text-primary hover:underline">
						Return Home
					</a>
				</div>
			)
		}
	</div>
</Layout>
