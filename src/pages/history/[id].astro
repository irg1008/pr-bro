---
import { WorkoutLogEditor } from "@/components/WorkoutLogEditor";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { GET } from "../api/workout-logs/[id]";

const { id } = Astro.params;

if (!id) {
	return Astro.redirect("/history");
}

const response = await GET(Astro);

if (response.status === 404) {
	return Astro.redirect("/404");
}

import type {
	Exercise,
	Routine,
	RoutineGroup,
	WorkoutLog,
	WorkoutLogEntry,
} from "prisma/generated/client";
type WorkoutLogWithDetails = WorkoutLog & {
	routine: Routine & { group: RoutineGroup };
	entries: (WorkoutLogEntry & { exercise: Exercise })[];
};

const log: WorkoutLogWithDetails = await response.json();

if (!log) {
	return Astro.redirect("/404");
}
---

<BaseLayout title={`Edit ${log.routine.name}`}>
	<div class="container mx-auto py-8 px-4">
		<div class="mb-6">
			<a href="/history" class="text-sm text-muted-foreground hover:underline"
				>‚Üê Back to History</a
			>
			<h1 class="text-3xl font-bold mt-2">{log.routine.name}</h1>
			<p class="text-muted-foreground">
				{log.routine.group.name} &bull; {
					new Date(log.createdAt).toLocaleDateString()
				}
			</p>
		</div>

		<WorkoutLogEditor
			client:load
			initialEntries={log.entries}
			onSave={async (entries) => {
				await fetch(`/api/workout-logs/${log.id}`, {
					method: "PUT",
					body: JSON.stringify({ entries }),
					headers: { "Content-Type": "application/json" },
				});
			}}
			onDelete={async () => {
				if (confirm("Are you sure you want to delete this log?")) {
					await fetch(`/api/workout-logs/${log.id}`, {
						method: "DELETE",
					});
				}
			}}
		/>
	</div>
</BaseLayout>
