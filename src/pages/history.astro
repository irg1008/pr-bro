---
import { DeleteHistoryButton } from "@/components/DeleteHistoryButton";
import { LogDateDisplay } from "@/components/LogDateDisplay";
import { Button } from "@/components/ui/button";
import { Card, CardHeader, CardTitle } from "@/components/ui/card";
import { DeloadBadge } from "@/components/ui/DeloadBadge";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { WorkoutService } from "@/services/workout-service";
import { ChevronLeft, ChevronRight } from "lucide-react";

// Pagination settings
const PageSize = 5;
const pageParam = Astro.url.searchParams.get("page");
const currentPage = pageParam ? parseInt(pageParam) : 1;

const { paginatedCycles, totalPages, totalCycles } =
	await WorkoutService.getHistoryPageData(currentPage, PageSize);
---

<BaseLayout title="Workout History">
	<div class="container mx-auto py-8 px-4 max-w-xl">
		<div class="flex justify-between items-center mb-8">
			<h1 class="text-3xl font-bold text-foreground">Workout History</h1>
			<DeleteHistoryButton client:visible />
		</div>

		<div class="space-y-12">
			{
				paginatedCycles.map((cycle) => (
					<div class="space-y-6">
						{/* Cycle Header */}
						<div class="flex items-center justify-between border-b border-border/50 pb-3">
							<div>
								<h2 class="text-lg font-bold text-foreground">
									{cycle.groupName} - Cycle {cycle.cycleNumber}
								</h2>
								<p class="text-xs text-muted-foreground">
									{cycle.startDate.toLocaleDateString(undefined, {
										month: "short",
										day: "numeric",
									})}{" "}
									-{" "}
									{cycle.endDate.toLocaleDateString(undefined, {
										month: "short",
										day: "numeric",
									})}
								</p>
							</div>
							<div class="bg-muted px-2 py-1 rounded text-xs font-medium">
								{cycle.durationDays} Days
							</div>
						</div>

						{/* Logs List */}
						<div class="space-y-4">
							{cycle.logs.map((log) => (
								<a href={`/history/${log.id}`} class="block group">
									<Card className="border-border/40 bg-card/50 transition-all hover:scale-[1.01] active:scale-[0.99] hover:bg-card/30 relative overflow-hidden">
										<CardHeader className="p-5">
											<div class="flex justify-between items-start z-10 relative">
												<div>
													<CardTitle className="font-bold text-base capitalize flex items-center gap-2 text-foreground">
														{log.routine.name}
														{log.isDeload && <DeloadBadge />}
													</CardTitle>
													<p class="text-xs text-muted-foreground mt-1">
														<LogDateDisplay
															client:load
															createdAt={log.createdAt}
															finishedAt={log.finishedAt}
														/>
													</p>
												</div>
												<div class="text-right">
													<div class="text-sm font-medium">
														{log.finishedAt
															? (() => {
																	const diff = Math.round(
																		(new Date(log.finishedAt).getTime() -
																			new Date(log.createdAt).getTime()) /
																			1000,
																	);
																	return diff >= 3600
																		? Math.floor(diff / 3600) +
																				"h " +
																				Math.round((diff % 3600) / 60) +
																				"m"
																		: Math.round(diff / 60) + " min";
																})()
															: "N/A"}
													</div>
												</div>
											</div>
										</CardHeader>
									</Card>
								</a>
							))}
						</div>
					</div>
				))
			}

			{
				totalCycles === 0 && (
					<div class="text-center py-12 px-4 text-muted-foreground border-2 border-dashed rounded-lg bg-muted/20">
						<p class="text-lg mb-2 font-medium">No history available yet</p>
						<p class="text-sm">Complete your first workout to see it here!</p>
					</div>
				)
			}
		</div>

		{/* Pagination Controls */}
		{
			totalPages > 1 && (
				<div class="flex justify-center gap-4 mt-8 pt-4 border-t">
					<Button
						variant="outline"
						size="icon"
						disabled={currentPage <= 1}
						asChild
					>
						<a href={currentPage > 1 ? `?page=${currentPage - 1}` : undefined}>
							<ChevronLeft className="h-4 w-4" />
						</a>
					</Button>

					<div class="flex items-center text-sm font-medium">
						Page {currentPage} of {totalPages}
					</div>

					<Button
						variant="outline"
						size="icon"
						disabled={currentPage >= totalPages}
						asChild
					>
						<a
							href={
								currentPage < totalPages
									? `?page=${currentPage + 1}`
									: undefined
							}
						>
							<ChevronRight className="h-4 w-4" />
						</a>
					</Button>
				</div>
			)
		}
	</div>
</BaseLayout>
