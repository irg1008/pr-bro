---
import BaseLayout from "@/layouts/BaseLayout.astro";
import type {
	Routine,
	RoutineGroup,
	WorkoutLog,
} from "prisma/generated/client";
import { GET } from "./api/workout-logs";

const response = await GET(Astro);
type WorkoutLogWithRoutine = WorkoutLog & {
	routine: Routine & { group: RoutineGroup };
};
const allLogs: WorkoutLogWithRoutine[] = await response.json();
const logs = allLogs.filter((log) => log.finishedAt);
---

<BaseLayout title="Workout History">
	<div class="container mx-auto py-8 px-4">
		<h1 class="text-3xl font-bold mb-8">Workout History</h1>

		<div class="space-y-4">
			{
				logs.map((log) => (
					<a
						href={`/history/${log.id}`}
						class="block rounded-lg border bg-card text-card-foreground shadow-sm p-4 hover:bg-accent transition-colors"
					>
						<div class="flex justify-between items-start">
							<div>
								<h3 class="font-bold text-lg capitalize">{log.routine.name}</h3>
								<p class="text-sm text-muted-foreground capitalize">
									{log.routine.group.name}
								</p>
								<p class="text-xs text-muted-foreground mt-1">
									{new Date(log.createdAt).toLocaleDateString()} &bull;{" "}
									{new Date(log.createdAt).toLocaleTimeString([], {
										hour: "2-digit",
										minute: "2-digit",
									})}
									{log.finishedAt && (
										<span>
											{" "}
											-{" "}
											{new Date(log.finishedAt).toLocaleTimeString([], {
												hour: "2-digit",
												minute: "2-digit",
											})}
										</span>
									)}
								</p>
							</div>
							<div class="text-right">
								<div class="text-sm font-medium">
									{log.finishedAt
										? (() => {
												const diff = Math.round(
													(new Date(log.finishedAt).getTime() -
														new Date(log.createdAt).getTime()) /
														1000,
												);
												return diff >= 3600
													? Math.floor(diff / 3600) +
															"h " +
															Math.round((diff % 3600) / 60) +
															"m"
													: Math.round(diff / 60) + " min";
											})()
										: "N/A"}
								</div>
							</div>
						</div>
					</a>
				))
			}
			{
				(
					<div class="text-center py-12 text-muted-foreground border-2 border-dashed rounded-lg bg-muted/20">
						<p class="text-lg mb-2 font-medium">No history available yet</p>
						<p class="text-sm">Complete your first workout to see it here!</p>
					</div>
				)
			}
		</div>
	</div>
</BaseLayout>
